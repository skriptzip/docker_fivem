name: ðŸ³ Auto-Build FiveM Docker Images

on:
  schedule:
    # Alle 2 Wochen am Sonntag 02:00 UTC
    - cron: '0 2 * * 0'
  
  # Manuell auslÃ¶sen
  workflow_dispatch:

  # Bei Dockerfile Changes bauen
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - 'config/**'
      - '.github/workflows/build.yml'

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
      should-build: ${{ steps.build-matrix.outputs.should-build }}
    
    steps:
      - name: ðŸ” Hole FiveM Artifacts von artifacts.jgscripts.com
        id: fetch-artifacts
        run: |
          echo "Hole FiveM Artifacts API Daten von artifacts.jgscripts.com/json..."
          
          # Hole JSON API Daten
          API_RESPONSE=$(curl -sL --max-time 30 https://artifacts.jgscripts.com/json 2>&1)
          
          if [ $? -ne 0 ] || [ -z "$API_RESPONSE" ]; then
            echo "âš ï¸ Kann API nicht abrufen, nutze Fallback-Liste"
            echo "use_fallback=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Validiere JSON
          echo "$API_RESPONSE" | jq . > /dev/null 2>&1
          if [ $? -ne 0 ]; then
            echo "âš ï¸ UngÃ¼ltiges JSON von API, nutze Fallback-Liste"
            echo "use_fallback=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extrahiere recommendedArtifact
          RECOMMENDED=$(echo "$API_RESPONSE" | jq -r '.recommendedArtifact // empty')
          
          if [ -z "$RECOMMENDED" ]; then
            echo "âš ï¸ Keine recommendedArtifact in API gefunden, nutze Fallback-Liste"
            echo "use_fallback=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extrahiere linuxDownloadLink
          LINUX_DL=$(echo "$API_RESPONSE" | jq -r '.linuxDownloadLink // empty')
          
          if [ -z "$LINUX_DL" ]; then
            echo "âš ï¸ Keine linuxDownloadLink in API gefunden, nutze Fallback-Liste"
            echo "use_fallback=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extrahiere volle Version aus Download-Link (Format: XXXXX-hash)
          # z.B. aus: https://runtime.fivem.net/.../24574-315823736cfbc085104ca0d32779311cd2f1a5a8/fx.tar.xz
          FULL_VERSION=$(echo "$LINUX_DL" | grep -oE '[0-9]{4,6}-[a-f0-9]{40}')
          
          if [ -z "$FULL_VERSION" ]; then
            echo "âš ï¸ Kann Version nicht aus Download-Link extrahieren, nutze Fallback"
            echo "use_fallback=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Empfohlene Artifact gefunden:"
          echo "   Version: $RECOMMENDED"
          echo "   Full Version: $FULL_VERSION"
          echo "   Download: $LINUX_DL"
          
          # Speichere fÃ¼r nÃ¤chsten Schritt
          echo "recommended=$RECOMMENDED" >> $GITHUB_OUTPUT
          echo "full_version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "use_fallback=false" >> $GITHUB_OUTPUT
      
      - name: ðŸ“‹ Erstelle Build-Matrix
        id: build-matrix
        run: |
          USE_FALLBACK="${{ steps.fetch-artifacts.outputs.use_fallback }}"
          
          if [ "$USE_FALLBACK" = "true" ]; then
            # Fallback: Nutze statische Artifact-Liste basierend auf Dockerfile-Defaults
            # HINWEIS: Hashes sind Platzhalter und werden nur verwendet wenn artifacts.jgscripts.com
            # nicht erreichbar ist. Diese sollten durch echte Versionen aus dem Dockerfile ersetzt werden.
            echo "âš ï¸ Nutze Fallback-Artifact-Liste (basierend auf Dockerfile-Defaults)"
            
            # Erstelle Fallback mit nur einer Version (Dockerfile default)
            ARTIFACT="18443"
            FULL_VER="18443-746f079d418d6a05ae5fe78268bc1b4fd66ce738"
            
            MATRIX="[{\"artifact\":\"$ARTIFACT\",\"fullver\":\"$FULL_VER\",\"tag\":\"latest\"}]"
            COUNT=1
          else
            # Nutze empfohlene Artifact von API
            RECOMMENDED="${{ steps.fetch-artifacts.outputs.recommended }}"
            FULL_VERSION="${{ steps.fetch-artifacts.outputs.full_version }}"
            
            echo "âœ… Nutze empfohlene Artifact von API:"
            echo "   Artifact: $RECOMMENDED"
            echo "   Full Version: $FULL_VERSION"
            
            # Erstelle Matrix mit empfohlener Version
            # Tag als "latest" und Build-Step erstellt auch Tag mit Versionsnummer
            MATRIX="[{\"artifact\":\"$RECOMMENDED\",\"fullver\":\"$FULL_VERSION\",\"tag\":\"latest\"}]"
            COUNT=1
          fi
          
          echo "âœ… Matrix erstellt mit $COUNT Artifact(s)"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "should-build=true" >> $GITHUB_OUTPUT
          
          # FÃ¼r Log
          echo "Zu bauende Artifacts:"
          echo "$MATRIX" | jq .

  build:
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        build: ${{ fromJson(needs.discover.outputs.matrix) }}
      max-parallel: 2
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ”‘ Login ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ³ Buildx Setup
        uses: docker/setup-buildx-action@v3
      
      - name: ðŸ”¨ Build ${{ matrix.build.artifact }}
        run: |
          ARTIFACT=${{ matrix.build.artifact }}
          FULL_VER=${{ matrix.build.fullver }}
          TAG=${{ matrix.build.tag }}
          IMAGE="ghcr.io/${{ github.repository_owner }}/fivem"
          
          echo "ðŸ”¨ Building: $IMAGE:$TAG"
          echo "   Artifact: $ARTIFACT"
          echo "   Full Version: $FULL_VER"
          
          # Build tags: always include the specified TAG, plus ARTIFACT if different
          # FÃ¼r "latest" wird auch der Versions-Tag hinzugefÃ¼gt (z.B. "24574")
          BUILD_TAGS="-t $IMAGE:$TAG"
          if [ "$TAG" != "$ARTIFACT" ]; then
            BUILD_TAGS="$BUILD_TAGS -t $IMAGE:$ARTIFACT"
          fi
          
          docker buildx build \
            --push \
            -f Dockerfile \
            --build-arg FIVEM_NUM=$ARTIFACT \
            --build-arg FIVEM_VER=$FULL_VER \
            --build-arg DATA_VER=0e7ba538339f7c1c26d0e689aa750a336576cf02 \
            $BUILD_TAGS \
            .
          
          if [ $? -eq 0 ]; then
            echo "âœ… Built: $IMAGE:$TAG"
            if [ "$TAG" != "$ARTIFACT" ]; then
              echo "âœ… Also tagged as: $IMAGE:$ARTIFACT"
            fi
          else
            exit 1
          fi

  no-build:
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.should-build != 'true'
    
    steps:
      - name: â­ï¸ Skip
        run: |
          echo "â­ï¸ Build Ã¼bersprungen - keine gÃ¼ltigen Artifacts gefunden"
          echo "   artifacts.jgscripts.com API konnte nicht abgerufen werden"

  summary:
    needs: [discover, build]
    runs-on: ubuntu-latest
    if: success() && needs.discover.outputs.should-build == 'true'
    permissions:
      contents: write
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ“ Update README Badge
        run: |
          # Get the artifact version from discover job
          MATRIX='${{ needs.discover.outputs.matrix }}'
          ARTIFACT=$(echo "$MATRIX" | jq -r '.[0].artifact')
          
          if [ -z "$ARTIFACT" ] || [ "$ARTIFACT" == "null" ]; then
            echo "::error::Failed to extract artifact version from matrix"
            exit 1
          fi
          
          echo "Updating README badge with FiveM version: $ARTIFACT"
          
          # Update the badge in README.md
          sed -i "s|https://img.shields.io/badge/fivem-[0-9]*-green.svg|https://img.shields.io/badge/fivem-$ARTIFACT-green.svg|g" README.md
          
          # Check if there were changes
          if git diff --quiet README.md; then
            echo "No changes to README.md"
          else
            echo "README.md updated with new version badge"
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "chore: update FiveM version badge to $ARTIFACT"
            if ! git push; then
              echo "::error::Failed to push README changes"
              exit 1
            fi
            echo "âœ… Successfully updated README with version $ARTIFACT"
          fi
      
      - name: âœ… Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## âœ… Build Complete
          
          **Registry:** ghcr.io/${{ github.repository_owner }}/fivem
          
          ### Images Built:
          Das empfohlene FiveM Docker Image wurde erfolgreich gebaut und gepusht!
          
          Die aktuelle empfohlene Version wurde automatisch von artifacts.jgscripts.com abgerufen.
          
          **VerfÃ¼gbare Tags:**
          - `latest` - Aktuell empfohlene Version (wird bei jedem Build aktualisiert)
          - `[VERSION]` - Spezifische Versionsnummer (z.B. `24574`) - **bleibt permanent bestehen!**
          
          **Wichtig:** Alte Versions-Tags werden nie Ã¼berschrieben und bleiben dauerhaft im Registry verfÃ¼gbar.
          FÃ¼r Produktionsumgebungen wird empfohlen, spezifische Versionsnummern statt `latest` zu verwenden.
          
          LÃ¤uft automatisch alle 2 Wochen am Sonntag um 02:00 UTC!
          EOF
