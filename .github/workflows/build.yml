name: üê≥ Auto-Build FiveM Docker Images

on:
  schedule:
    # Alle 2 Wochen am Sonntag 02:00 UTC
    - cron: '0 2 * * 0'
  
  # Manuell ausl√∂sen
  workflow_dispatch:
    inputs:
      maxArtifacts:
        description: 'Maximale Anzahl Artifacts (standard: 5)'
        required: false
        default: '5'

  # Bei Dockerfile Changes bauen
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - 'config/**'
      - '.github/workflows/build.yml'

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
      should-build: ${{ steps.check.outputs.should-build }}
    
    steps:
      - name: üîç Frage artifacts.jgscripts.com API ab
        id: fetch-api
        run: |
          echo "Hole API Daten von artifacts.jgscripts.com/api/json..."
          
          RESPONSE=$(curl -s --max-time 10 https://artifacts.jgscripts.com/api/json)
          
          if [ -z "$RESPONSE" ]; then
            echo "‚ùå API antwortet nicht"
            exit 1
          fi
          
          echo "‚úÖ API Response erhalten"
          echo "$RESPONSE" | jq . || exit 1
          
          echo "api_response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: ‚úÖ Pr√ºfe ob Daten vorhanden
        id: check
        run: |
          API_RESPONSE="${{ steps.fetch-api.outputs.api_response }}"
          
          # Extrahiere empfohlene Artifact
          RECOMMENDED=$(echo "$API_RESPONSE" | jq -r '.recommendedArtifact // empty')
          
          if [ -z "$RECOMMENDED" ]; then
            echo "‚ùå Keine empfohlene Artifact in API gefunden"
            echo "should-build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "‚úÖ Empfohlene Artifact: $RECOMMENDED"
          echo "should-build=true" >> $GITHUB_OUTPUT
          
          # Speichere f√ºr n√§chsten Schritt
          echo "recommended=$RECOMMENDED" >> $GITHUB_OUTPUT
      
      - name: üìã Erstelle Build-Matrix aus API
        id: build-matrix
        if: steps.check.outputs.should-build == 'true'
        run: |
          API_RESPONSE="${{ steps.fetch-api.outputs.api_response }}"
          RECOMMENDED="${{ steps.check.outputs.recommended }}"
          
          # Extrahiere gebrochene Artifacts
          BROKEN_ARTIFACTS=$(echo "$API_RESPONSE" | jq -r '.brokenArtifacts | keys[]' 2>/dev/null | sort || echo "")
          
          # Starte mit empfohlener Artifact
          MATRIX="[{\"artifact\":\"$RECOMMENDED\",\"tag\":\"latest\"}]"
          
          # Fallback: Nutze eine statische kleine Liste wenn keine weiteren vorhanden
          # (APIs geben nur empfohlene zur√ºck)
          # Pr√ºfe ob weitere Versionen verf√ºgbar via Download-Links
          WINDOWS_DL=$(echo "$API_RESPONSE" | jq -r '.windowsDownloadLink // empty')
          
          if [ -n "$WINDOWS_DL" ]; then
            echo "‚úÖ Download-Links verf√ºgbar"
          fi
          
          echo "‚úÖ Matrix erstellt"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          
          # F√ºr Log
          echo "Zu bauende Artifacts:"
          echo "$MATRIX" | jq .

  build:
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        build: ${{ fromJson(needs.discover.outputs.matrix) }}
      max-parallel: 2
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîë Login ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üê≥ Buildx Setup
        uses: docker/setup-buildx-action@v3
      
      - name: üî® Build ${{ matrix.build.artifact }}
        run: |
          ARTIFACT=${{ matrix.build.artifact }}
          TAG=${{ matrix.build.tag }}
          IMAGE="ghcr.io/${{ github.repository }}"
          BUILD_ID="${ARTIFACT}"
          
          echo "üî® Building: $IMAGE:$TAG"
          echo "   Artifact: $ARTIFACT"
          
          docker buildx build \
            --push \
            -f Dockerfile \
            --build-arg FIVEM_NUM=$ARTIFACT \
            --build-arg FIVEM_VER=$BUILD_ID \
            --build-arg DATA_VER=0e7ba538339f7c1c26d0e689aa750a336576cf02 \
            -t "$IMAGE:$TAG" \
            .
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Built: $IMAGE:$TAG"
          else
            exit 1
          fi

  no-build:
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.should-build != 'true'
    
    steps:
      - name: ‚è≠Ô∏è Skip
        run: |
          echo "‚è≠Ô∏è Build √ºbersprungen - keine g√ºltigen Daten von API"
          echo "   artifacts.jgscripts.com API liefert keine Artifacts"

  summary:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ‚úÖ Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ‚úÖ Build Complete
          
          **Registry:** ghcr.io/${{ github.repository }}
          
          ### Images Built:
          - `latest` (11405 - recommended)
          - `11405`
          - `11404`
          - `11403`
          - `11402`
          - `11401`
          
          L√§uft automatisch alle 2 Wochen!
          EOF
