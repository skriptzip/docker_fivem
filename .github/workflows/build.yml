name: üê≥ Auto-Build FiveM Docker Images

on:
  schedule:
    # Alle 2 Wochen am Sonntag 02:00 UTC
    - cron: '0 2 * * 0'
  
  # Manuell ausl√∂sen
  workflow_dispatch:
    inputs:
      maxArtifacts:
        description: 'Maximale Anzahl Artifacts (standard: 5)'
        required: false
        default: '5'

  # Bei Dockerfile Changes bauen
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - 'config/**'
      - '.github/workflows/build.yml'

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
      should-build: ${{ steps.build-matrix.outputs.should-build }}
    
    steps:
      - name: üîç Hole FiveM Artifacts von runtime.fivem.net
        id: fetch-artifacts
        run: |
          echo "Hole FiveM Artifacts von runtime.fivem.net..."
          
          # Hole HTML-Seite mit Artifacts
          ARTIFACTS_HTML=$(curl -sL --max-time 30 https://runtime.fivem.net/artifacts/fivem/build_proot_linux/master/ 2>&1)
          
          if [ $? -ne 0 ] || [ -z "$ARTIFACTS_HTML" ]; then
            echo "‚ö†Ô∏è Kann Artifacts-Seite nicht abrufen, nutze Fallback-Liste"
            echo "use_fallback=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extrahiere Artifact-Versionen (Format: XXXXX-hash)
          # Regex erlaubt 4-6 Ziffern f√ºr Versionsnummer (z.B. 11532, 18443)
          ARTIFACTS=$(echo "$ARTIFACTS_HTML" | grep -oE '[0-9]{4,6}-[a-f0-9]{40}' | sort -rn | uniq | head -10)
          
          if [ -z "$ARTIFACTS" ]; then
            echo "‚ö†Ô∏è Keine Artifacts gefunden, nutze Fallback-Liste"
            echo "use_fallback=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "‚úÖ Gefundene Artifacts (Top 10):"
          echo "$ARTIFACTS"
          
          # Speichere Artifacts
          echo "artifacts<<EOF" >> $GITHUB_OUTPUT
          echo "$ARTIFACTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "use_fallback=false" >> $GITHUB_OUTPUT
      
      - name: üìã Erstelle Build-Matrix
        id: build-matrix
        run: |
          MAX_ARTIFACTS=${{ github.event.inputs.maxArtifacts || '5' }}
          USE_FALLBACK="${{ steps.fetch-artifacts.outputs.use_fallback }}"
          
          if [ "$USE_FALLBACK" = "true" ]; then
            # Fallback: Nutze statische Artifact-Liste basierend auf Dockerfile-Defaults
            # HINWEIS: Hashes sind Platzhalter und werden nur verwendet wenn runtime.fivem.net
            # nicht erreichbar ist. Diese sollten durch echte Versionen aus dem Dockerfile ersetzt werden.
            echo "‚ö†Ô∏è Nutze Fallback-Artifact-Liste (basierend auf Dockerfile-Defaults)"
            
            # Erstelle Fallback-Liste mit realistischen Versionen (basierend auf Dockerfile v18443)
            FALLBACK_VERSIONS="18443-746f079d418d6a05ae5fe78268bc1b4fd66ce738
          18442-746f079d418d6a05ae5fe78268bc1b4fd66ce737
          18441-746f079d418d6a05ae5fe78268bc1b4fd66ce736
          18440-746f079d418d6a05ae5fe78268bc1b4fd66ce735
          18439-746f079d418d6a05ae5fe78268bc1b4fd66ce734"
            
            # Erstelle Matrix-JSON f√ºr Fallback (respektiert MAX_ARTIFACTS)
            MATRIX="["
            FIRST=true
            COUNT=0
            
            while IFS= read -r ARTIFACT; do
              if [ -z "$ARTIFACT" ]; then
                continue
              fi
              
              VERSION=$(echo "$ARTIFACT" | cut -d'-' -f1)
              
              if [ $COUNT -eq 0 ]; then
                TAG="latest"
              else
                TAG="$VERSION"
              fi
              
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                MATRIX="$MATRIX,"
              fi
              
              MATRIX="$MATRIX{\"artifact\":\"$VERSION\",\"fullver\":\"$ARTIFACT\",\"tag\":\"$TAG\"}"
              
              COUNT=$((COUNT + 1))
              if [ $COUNT -ge $MAX_ARTIFACTS ]; then
                break
              fi
            done <<< "$FALLBACK_VERSIONS"
            
            MATRIX="$MATRIX]"
          else
            ARTIFACTS="${{ steps.fetch-artifacts.outputs.artifacts }}"
            
            # Erstelle Matrix-JSON
            MATRIX="["
            FIRST=true
            COUNT=0
            
            while IFS= read -r ARTIFACT; do
              if [ -z "$ARTIFACT" ]; then
                continue
              fi
              
              # Extrahiere Versionsnummer (vor dem Bindestrich)
              VERSION=$(echo "$ARTIFACT" | cut -d'-' -f1)
              
              if [ $COUNT -eq 0 ]; then
                TAG="latest"
              else
                TAG="$VERSION"
              fi
              
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                MATRIX="$MATRIX,"
              fi
              
              MATRIX="$MATRIX{\"artifact\":\"$VERSION\",\"fullver\":\"$ARTIFACT\",\"tag\":\"$TAG\"}"
              
              COUNT=$((COUNT + 1))
              if [ $COUNT -ge $MAX_ARTIFACTS ]; then
                break
              fi
            done <<< "$ARTIFACTS"
            
            MATRIX="$MATRIX]"
          fi
          
          echo "‚úÖ Matrix erstellt mit $COUNT Artifacts"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "should-build=true" >> $GITHUB_OUTPUT
          
          # F√ºr Log
          echo "Zu bauende Artifacts:"
          echo "$MATRIX" | jq .

  build:
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.should-build == 'true'
    permissions:
      contents: read
      packages: write
    
    strategy:
      matrix:
        build: ${{ fromJson(needs.discover.outputs.matrix) }}
      max-parallel: 2
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
      
      - name: üîë Login ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üê≥ Buildx Setup
        uses: docker/setup-buildx-action@v3
      
      - name: üî® Build ${{ matrix.build.artifact }}
        run: |
          ARTIFACT=${{ matrix.build.artifact }}
          FULL_VER=${{ matrix.build.fullver }}
          TAG=${{ matrix.build.tag }}
          IMAGE="ghcr.io/${{ github.repository }}"
          
          echo "üî® Building: $IMAGE:$TAG"
          echo "   Artifact: $ARTIFACT"
          echo "   Full Version: $FULL_VER"
          
          # Build tags: always include the specified TAG, plus ARTIFACT if different
          BUILD_TAGS="-t $IMAGE:$TAG"
          if [ "$TAG" != "$ARTIFACT" ]; then
            BUILD_TAGS="$BUILD_TAGS -t $IMAGE:$ARTIFACT"
          fi
          
          docker buildx build \
            --push \
            -f Dockerfile \
            --build-arg FIVEM_NUM=$ARTIFACT \
            --build-arg FIVEM_VER=$FULL_VER \
            --build-arg DATA_VER=0e7ba538339f7c1c26d0e689aa750a336576cf02 \
            $BUILD_TAGS \
            .
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Built: $IMAGE:$TAG"
            if [ "$TAG" != "$ARTIFACT" ]; then
              echo "‚úÖ Also tagged as: $IMAGE:$ARTIFACT"
            fi
          else
            exit 1
          fi

  no-build:
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.should-build != 'true'
    
    steps:
      - name: ‚è≠Ô∏è Skip
        run: |
          echo "‚è≠Ô∏è Build √ºbersprungen - keine g√ºltigen Artifacts gefunden"
          echo "   runtime.fivem.net konnte nicht abgerufen werden"

  summary:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ‚úÖ Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ‚úÖ Build Complete
          
          **Registry:** ghcr.io/${{ github.repository }}
          
          ### Images Built:
          FiveM Docker Images wurden erfolgreich gebaut und gepusht!
          
          Die neuesten Artifacts wurden automatisch von runtime.fivem.net abgerufen.
          
          **Verf√ºgbare Tags:**
          - `latest` - Neueste empfohlene Version
          - `[VERSION]` - Spezifische Versionsnummern
          
          L√§uft automatisch alle 2 Wochen am Sonntag um 02:00 UTC!
          EOF
